---
phase: 04-gameplay-timing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [main.js]
autonomous: true

must_haves:
  truths:
    - "Game updates at consistent 50 Hz regardless of display refresh rate"
    - "Road crossing uses discrete step movement (16px per step)"
    - "Movement feels snappy and predictable"
  artifacts:
    - path: "main.js"
      provides: "Fixed timestep game loop and discrete movement"
      contains: "FIXED_DT"
  key_links:
    - from: "loop()"
      to: "updateRoad()/updateSki()"
      via: "Fixed timestep accumulator pattern"
---

<objective>
Implement authentic ZX Spectrum timing: 50Hz fixed timestep and discrete step movement.

Purpose: Original ZX Spectrum ran at 50Hz (PAL). Movement should feel discrete/steppy like the original, not smooth/continuous.
Output: Game loop runs at consistent 50Hz with discrete step-based road crossing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert to 50Hz fixed timestep</name>
  <files>main.js</files>
  <action>
Implement fixed timestep game loop:
1. Add constant `const FIXED_DT = 1/50` (50Hz = 0.02s per update)
2. Add accumulator variable `let accumulator = 0`
3. Modify loop() to use fixed timestep pattern:
   - Add frame delta to accumulator
   - While accumulator >= FIXED_DT: run update with FIXED_DT, subtract from accumulator
   - Draw uses interpolation or just renders current state
4. Update functions receive FIXED_DT instead of variable dt
5. Keep the dt clamp at 0.04 to prevent spiral of death on tab switch

Pattern:
```javascript
function loop(timestamp) {
  if (!state.lastTime) state.lastTime = timestamp;
  const frameDt = Math.min(0.04, (timestamp - state.lastTime) / 1000);
  state.lastTime = timestamp;

  accumulator += frameDt;
  while (accumulator >= FIXED_DT) {
    // Update at fixed rate
    if (state.mode === MODE.ROAD) updateRoad(FIXED_DT);
    if (state.mode === MODE.SKI) updateSki(FIXED_DT);
    accumulator -= FIXED_DT;
  }

  draw(frameDt); // Drawing still uses frame time for animations
  updateHUD();
  requestAnimationFrame(loop);
}
```
  </action>
  <verify>Run game, verify smooth consistent movement - no jitter or stutter</verify>
  <done>Game loop runs at fixed 50Hz timestep with accumulator pattern</done>
</task>

<task type="auto">
  <name>Task 2: Implement discrete step movement for road crossing</name>
  <files>main.js</files>
  <action>
Change keyboard road crossing from continuous to discrete step movement (TIME-03):

1. Define step size constant: `const ROAD_STEP_SIZE = 16` (one cell height)
2. Add step tracking: `let stepCooldown = 0` in state or module scope
3. Modify updateRoad() keyboard handling:
   - Remove acceleration/speed-based movement
   - On key press (with cooldown): move exactly ROAD_STEP_SIZE pixels
   - Add cooldown (e.g., 0.1s) between steps for key-held behavior
   - Left/right also use step-based movement

Pattern for updateRoad keyboard section:
```javascript
if (controlMode === 'keyboard') {
  stepCooldown -= FIXED_DT;
  if (stepCooldown <= 0) {
    let moved = false;
    if (input.up) {
      horace.y -= ROAD_STEP_SIZE;
      moved = true;
    } else if (input.down) {
      horace.y += ROAD_STEP_SIZE;
      moved = true;
    }
    if (input.left) {
      horace.x -= ROAD_STEP_SIZE;
      moved = true;
    }
    if (input.right) {
      horace.x += ROAD_STEP_SIZE;
      moved = true;
    }
    if (moved) {
      playMove();
      stepCooldown = 0.12; // 8 steps per second when holding key
    }
  }
}
```

4. Remove horace.speed/acceleration/deceleration usage from road crossing
5. Keep swipe mode as-is (already step-based)
6. Constrain position after step

Note: Ski mode keeps continuous movement (downhill skiing is smooth, not steppy)
  </action>
  <verify>Test road crossing with keyboard - should move in discrete 16px steps, not smooth glide</verify>
  <done>Road crossing uses discrete 16px steps per keypress/hold, feels like original game</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Game runs at 50Hz fixed timestep (verify by logging update count per second)
- [ ] Road crossing keyboard movement is discrete/steppy
- [ ] Ski mode still feels smooth (continuous downhill)
- [ ] No visual jitter or stutter
- [ ] Tab switching doesn't cause time accumulation issues
</verification>

<success_criteria>
- All tasks completed
- Fixed 50Hz timestep verified
- Road crossing feels snappy and discrete
- Ski mode remains smooth
</success_criteria>

<output>
After completion, create `.planning/phases/04-gameplay-timing/04-01-SUMMARY.md`
</output>
