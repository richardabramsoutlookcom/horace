---
phase: 04-gameplay-timing
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified: [main.js]
autonomous: true

must_haves:
  truths:
    - "Missing gate loses points, not life"
    - "Finish line awards 100-point bonus"
    - "Tree collisions have variable outcome (sometimes continue, sometimes crash)"
    - "Ski jump sound plays when jumping"
  artifacts:
    - path: "main.js"
      provides: "Authentic scoring and tree collision behavior"
      contains: "GATE_MISS_PENALTY"
  key_links:
    - from: "gate miss logic"
      to: "score deduction"
      via: "Subtract points instead of loseLife()"
    - from: "tree collision"
      to: "random outcome"
      via: "Math.random() determines crash vs continue"
---

<objective>
Fix gate scoring and tree collisions to match original gameplay.

Purpose: Original game didn't lose a life for missing gates (just point penalty). Tree collisions had variable outcomes - sometimes you'd continue, sometimes crash.
Output: Authentic gate miss handling, tree collision variation, correct finish bonus.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-gameplay-timing/04-02-SUMMARY.md
@main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix gate miss and finish bonus scoring</name>
  <files>main.js</files>
  <action>
1. GAME-05: Gate miss loses points, not life - modify updateSki() gate logic:

   Current (wrong):
   ```javascript
   } else {
     playGateMiss();
     loseLife("Missed gate!", false);
     return;
   }
   ```

   Change to:
   ```javascript
   } else {
     gate.passed = true;  // Mark as passed to avoid repeat penalty
     const penalty = 10;  // Point penalty for miss
     state.score = Math.max(0, state.score - penalty);
     playGateMiss();
     setMessage("Missed gate! -10");
     // Continue skiing - don't lose life
   }
   ```

2. GAME-07: Fix finish line bonus from 150 to 100:
   Find: `state.score += 150;` in the ski run completion section
   Change to: `state.score += 100;`

3. Wire ski jump sound (prepared in Phase 3):
   - Ski jump should trigger when pressing up/action key while skiing
   - Add jump state: `let isJumping = false; let jumpTimer = 0;`
   - In updateSki(), detect jump trigger:
   ```javascript
   // Jump mechanic (action key or spacebar)
   if (input.action && !isJumping) {
     isJumping = true;
     jumpTimer = 0.3;  // Jump duration
     playSkiJump();
   }
   if (isJumping) {
     jumpTimer -= FIXED_DT;
     if (jumpTimer <= 0) {
       isJumping = false;
     }
   }
   ```
   - While jumping, skip tree collision (can jump over trees):
   ```javascript
   for (const obstacle of obstacles) {
     if (!isJumping && circleRectOverlap(obstacle, horace)) {
       // Handle collision
     }
   }
   ```

4. Update input binding to support action/space for jump:
   - Already has `input.action` in input object
   - Add space bar to trigger action in keydown handler:
   ```javascript
   if (event.key === " " || event.key === "Space") input.action = true;
   ```
   - Add keyup handler:
   ```javascript
   if (event.key === " " || event.key === "Space") input.action = false;
   ```
  </action>
  <verify>
- Miss a gate intentionally, verify score drops by 10 and you continue skiing
- Complete ski run, verify 100 point bonus (not 150)
- Press space while skiing, verify jump sound plays
  </verify>
  <done>Gate miss gives point penalty only, finish bonus is 100, jump sound wired</done>
</task>

<task type="auto">
  <name>Task 2: Implement variable tree collision outcome</name>
  <files>main.js</files>
  <action>
GAME-08: Tree collisions have variable outcome:
- Sometimes Horace bounces off and continues (30% chance)
- Sometimes Horace crashes and loses life/skis (70% chance)

1. Modify tree/obstacle collision handling in updateSki():

   Current:
   ```javascript
   for (const obstacle of obstacles) {
     if (circleRectOverlap(obstacle, horace)) {
       loseLife("Hit obstacle!");
       return;
     }
   }
   ```

   Change to:
   ```javascript
   for (const obstacle of obstacles) {
     if (!isJumping && !obstacle.hit && circleRectOverlap(obstacle, horace)) {
       obstacle.hit = true;  // Prevent repeat collision

       // Variable outcome: 30% chance to bounce and continue
       if (Math.random() < 0.3) {
         // Lucky bounce - push player to the side
         playTreeCrash();  // Still play sound
         horace.x += (Math.random() > 0.5 ? 1 : -1) * 24;  // Bounce left or right
         horace.x = Math.max(0, Math.min(LOGICAL_W - horace.w, horace.x));
         setMessage("Lucky bounce!");
       } else {
         // Crash - lose life and skis
         playTreeCrash();
         loseLife("Crashed into tree!");
         return;
       }
     }
   }
   ```

2. Reset obstacle.hit flag when resetting ski run:
   In resetSkiRun(), after creating obstacles:
   ```javascript
   obstacles.push({
     x: 16 + Math.random() * (LOGICAL_W - 32),
     y: 100 + Math.random() * (slopeLength - 200),
     r: 8 + Math.random() * 4,
     hit: false,  // Add hit tracking
   });
   ```

3. Consider adding brief invulnerability after bounce to prevent immediate re-collision:
   Add `bounceInvuln` timer if needed for feel.
  </action>
  <verify>
- Hit trees multiple times, verify some hits let you continue (30%)
- Verify crash still loses life most of the time (70%)
- Verify bouncing pushes you away from tree
  </verify>
  <done>Tree collisions have variable outcome with 30% bounce/70% crash split</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Gate miss deducts points (not life) and allows continuing
- [ ] Finish line gives 100 points (not 150)
- [ ] Jump mechanic works with space bar
- [ ] Jump sound plays during jump
- [ ] Tree collisions sometimes let you continue (bounce)
- [ ] Tree collisions mostly cause crash (lose life)
- [ ] Game still feels challenging but fair
</verification>

<success_criteria>
- All tasks completed
- Gate scoring matches original behavior
- Tree collision variability creates authentic unpredictability
- Jump mechanic adds skillful avoidance option
</success_criteria>

<output>
After completion, create `.planning/phases/04-gameplay-timing/04-03-SUMMARY.md`
</output>
