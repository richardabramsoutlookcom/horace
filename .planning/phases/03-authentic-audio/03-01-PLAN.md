---
phase: 03-authentic-audio
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [main.js]
autonomous: true

must_haves:
  truths:
    - "All sounds have harsh, buzzy Spectrum beeper quality (no smooth waves)"
    - "Playing a new sound stops any currently playing sound"
    - "Car collision makes a descending buzz sound using square wave"
  artifacts:
    - path: "main.js"
      provides: "Single-channel audio system with square wave sounds"
      contains: "osc.type = 'square'"
  key_links:
    - from: "all play* functions"
      to: "currentOscillator tracking"
      via: "stop previous before start new"
      pattern: "currentOscillator.*stop|stopCurrentSound"
---

<objective>
Refactor audio system for authentic ZX Spectrum beeper behavior.

Purpose: The ZX Spectrum beeper was a 1-bit speaker that could only play one sound at a time using square waves. This plan establishes that foundation.
Output: Single-channel audio system where all sounds use square wave and new sounds interrupt previous.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@main.js — Current audio functions: initAudio, playBeep, playMove, playCarHit, playGatePass, playSkiEquipped, playModeChange (lines 223-272)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement single-channel audio system</name>
  <files>main.js</files>
  <action>
    Modify the audio system to enforce single-channel behavior:

    1. Add a module-level variable to track current oscillator: `let currentOscillator = null;`

    2. Create a helper function `stopCurrentSound()` that:
       - Checks if currentOscillator exists and is still active
       - Calls stop() on it with immediate timing
       - Sets currentOscillator to null

    3. Modify `playBeep(freq, duration, volume)` to:
       - Call stopCurrentSound() at the start
       - Store the new oscillator in currentOscillator before starting
       - Clear currentOscillator after duration (can use osc.onended callback)

    4. Modify `playCarHit()` to:
       - Call stopCurrentSound() at the start
       - Track its oscillator in currentOscillator
       - Store in currentOscillator before starting

    5. Modify `playSkiEquipped()` to:
       - Remove setTimeout-based overlapping sounds
       - Play a single ascending beep sequence where each note starts after previous ends
       - Use recursive approach or single oscillator with frequency changes

    This ensures only one sound plays at any time.
  </action>
  <verify>Manually test: rapidly trigger multiple sounds (e.g., collect gate then immediately hit car) - new sound should cut off previous</verify>
  <done>currentOscillator variable exists, all play functions call stopCurrentSound before creating new oscillator</done>
</task>

<task type="auto">
  <name>Task 2: Convert all sounds to square wave</name>
  <files>main.js</files>
  <action>
    Ensure all oscillators use square wave for authentic beeper sound:

    1. In `playCarHit()`:
       - Change `osc.type = "sawtooth"` to `osc.type = "square"`
       - Adjust the frequency ramp: square waves at low frequencies can be harsh
       - Consider range 200Hz down to 80Hz for the descending crash
       - May need to adjust volume (square waves are louder than sawtooth)

    2. Verify `playBeep()` already uses `osc.type = "square"` (it does)

    3. Review volume levels across all sounds:
       - Square waves are perceptually louder
       - May need to reduce volumes by ~20-30%
       - playBeep: 0.08 → consider 0.06
       - playCarHit: 0.2 → consider 0.12
       - Adjust to taste, keeping all sounds at similar perceived loudness

    The ZX Spectrum beeper was purely square wave. No other waveforms.
  </action>
  <verify>Open browser dev tools, play each sound, visually confirm no "sawtooth" string exists in audio code</verify>
  <done>All oscillator type assignments are "square", no other waveform types in audio code</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Search code for oscillator type - only "square" appears
- [ ] Search for setTimeout in playSkiEquipped - removed in favor of sequential/single sound
- [ ] All sounds still play (no audio breakage)
- [ ] New sound interrupts previous sound
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No audio-related errors in console
- Only square wave oscillators used
- Single-channel behavior enforced
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentic-audio/03-01-SUMMARY.md`
</output>
